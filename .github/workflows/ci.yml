name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements_ci.txt

      - name: Lint (ruff)
        run: ruff check .

      - name: Type check (mypy)
        run: mypy

      - name: Tests (pytest + overall coverage)
        run: pytest --maxfail=1 --disable-warnings --cov=custom_components/easy_control --cov-report=term-missing --cov-fail-under=60

      - name: Coverage gate (security-critical modules)
        run: >
          coverage report
          --include="custom_components/easy_control/network.py,custom_components/easy_control/pairing.py,custom_components/easy_control/proof.py,custom_components/easy_control/runtime_security.py,custom_components/easy_control/token.py"
          --fail-under=85

      - name: Dependency audit (manifest runtime requirements)
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          manifest_path = Path("custom_components/easy_control/manifest.json")
          output_path = Path(".ci_runtime_requirements.txt")

          manifest = json.loads(manifest_path.read_text(encoding="utf-8"))
          requirements = manifest.get("requirements", [])
          if not isinstance(requirements, list):
              raise SystemExit("manifest.json field 'requirements' must be a list")

          normalized: list[str] = []
          for requirement in requirements:
              if not isinstance(requirement, str) or not requirement.strip():
                  raise SystemExit("manifest.json contains an invalid requirement entry")
              normalized.append(requirement.strip())

          output_path.write_text("\n".join(normalized) + ("\n" if normalized else ""), encoding="utf-8")
          print(f"Wrote {len(normalized)} runtime requirement(s) from {manifest_path} to {output_path}")
          PY
          if [ -s .ci_runtime_requirements.txt ]; then
            pip-audit -r .ci_runtime_requirements.txt
          else
            echo "No custom runtime dependencies declared in manifest.json; skipping pip-audit."
          fi

      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-audit-full-env-info:
    name: Dependency audit (full CI env, informational)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements_ci.txt

      - name: Full dependency audit (informational only)
        id: pip_audit_full
        run: |
          set +e
          pip-audit > .pip-audit-full-env.txt 2>&1
          audit_exit_code=$?
          set -e
          echo "exit_code=$audit_exit_code" >> "$GITHUB_OUTPUT"
          echo "pip-audit exit code (informational): $audit_exit_code"
          exit 0

      - name: Write audit summary
        if: always()
        run: |
          {
            echo "## Full CI Environment Dependency Audit (Informational)"
            echo
            echo "- Status: non-blocking informational report"
            echo "- pip-audit exit code: \`${{ steps.pip_audit_full.outputs.exit_code }}\`"
            echo "- Scope: full installed CI test environment (includes HA test harness dependencies)"
            echo
            echo "### Report tail"
            echo '```text'
            tail -n 120 .pip-audit-full-env.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload full audit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-full-env-report
          path: .pip-audit-full-env.txt
          if-no-files-found: error
